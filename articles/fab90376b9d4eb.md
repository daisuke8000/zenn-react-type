---
title: "åƒ•ã¯ä»Šæ—¥ã‚‚depends_onã¨æˆ¯ã‚Œã‚‹"
emoji: "ğŸ„â€â™‚ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [docker]
published: true
---

## Dockerfileã¨ã‹docker-composeæ›¸ã„ã¦ã¾ã™ã‹ãƒ¼ï¼Ÿ
è‡ªåˆ†ã¯ã¡ã‚‡ã“ã¡ã‚‡ã“æ›¸ãã¾ã™ã€‚
ã§ã‚‚ã€å…¨ç„¶ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã¨ã‹ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°æ§‹æˆã¨ã‹ã¯æœªç†Ÿã§å›°ã£ãŸã‚‚ã‚“ã§ã™ã‚ˆã€‚
ãŠå‹‰å¼·çš„ãªæ„å‘³ã§æ›¸ã„ã¦ã‚‹æ„Ÿã˜ã§ã™ã€‚

ãã®ä¸­ã§ã¡ã‚‡ã“ã¡ã‚‡ã“ã‚ã‚‹ã‚“ã§ã™ãŒã€docker-composeã«æ›¸ãã€Œdepends_onã€ã€‚
ã“ã„ã¤ã‚’ã¡ã‚ƒã‚“ã¨ä½¿ãˆã¦ãªã‹ã£ãŸï¼ˆç†è§£ã—ã¦ãªã‹ã£ãŸï¼‰ã€‚
ã“ã“ã‚’å…¬å¼ã‚’ã¡ã‚ƒã‚“ã¨ã¿ã¦ã€æ•´ç†ã—ã¦ã„ãã€‚

https://docs.docker.com/compose/startup-order/

depends_onã¯ã‚ãã¾ã§ã€ã‚µãƒ¼ãƒ“ã‚¹ã®èµ·å‹•ã¨ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã®é †åºã‚’åˆ¶å¾¡ã—ã¦ã„ã‚‹ã ã‘ã§ã€ã‚³ãƒ³ãƒ†ãƒŠåŒå£«ã®çŠ¶æ…‹ã‚’ç›£è¦–ã—ã¦èµ·å‹•ã™ã‚‹ã¨ã‹ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é–“ã®ç–é€šç¢ºèªã‚’ã—ã¦ãã‚Œã‚‹ã‚ã‘ã§ã¯ãªã„ã‚“ã§ã™ã€‚

ä¾å­˜é–¢ä¿‚ã£ã¦è¨€è‘‰ã‚‚ã‚ã‚Šã¾ã—ãŸãŒã€å€‹äººçš„ã«ã¯ã€Œä¾å­˜é–¢ä¿‚ã€ã£ã¦è¨€è‘‰ãŒã¾ãŸã‚„ã‚„ã“ã—ã„éŸ¿ããªã®ã§ç§ã¯æ•¢ãˆã¦ä½¿ã„ã¾ã›ã‚“ã€‚ï¼ˆãã‚ŒãŒæ­£ã—ã„ã¨ã—ã¦ã‚‚ã€ãªã‚“ã‹ç´å¾—ã„ã‹ãªã„ï¼‰
ä¾‹ãˆã°ã€docker-composeã‚’å¤§ä½“ã“ã‚“ãªæ„Ÿã˜ã§æ›¸ã„ã¦ã‚‹ã¯ãšã§ã™ãŒã€ã“ã®å ´åˆã ã¨ã€ã€

- èµ·å‹•æ™‚ã¯ã€Œdbï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰ã€ -> ã€Œwebï¼ˆã‚¢ãƒ—ãƒªï¼‰ã€ã®é †

- åœæ­¢æ™‚ã¯ã€Œwebï¼ˆã‚¢ãƒ—ãƒªï¼‰ã€ -> ã€Œdbï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰ã€ ã®é †

ã¿ãŸã„ãªæ„Ÿã˜ã§ã€ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•ã¨åœæ­¢é †åºã‚’è¡Œã£ã¦ã„ã‚‹ã€‚

```yml
version: '3.8'
services:
  web:
    build: .
    ports:
      - 8000:8000
    volumes:
      - .:/app
    depends_on:
      - db

  db:
    image: mysql:5.7.22
    restart: always
    environment:
      MYSQL_DATABASE: develop
      MYSQL_USER: root
      MYSQL_PASSWORD: root
      MYSQL_ROOT_PASSWORD: root
    volumes:
      - .db:/var/lib/mysql
    ports:
      - 3306:3306
```


ãŸã ã—ã€å‰è¿°ã«æ›¸ã„ãŸã¨ãŠã‚Šã€ã“ã‚Œã¯ã‚ãã¾ã§èµ·å‹•é †åºã ã‘ã®ãŠè©±ã—ã§ã‚ã‚‹ã€‚

ã“ã®ã¾ã¾`docker-compose up`ã™ã‚‹ã¨ã€db(ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹)ãŒç¨¼åƒå‰ã«ã€web(ã‚¢ãƒ—ãƒª)ãŒç¨¼åƒã™ã‚‹ã®ã§ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ãŒç•°å¸¸çµ‚äº†ã¨ãªã‚Šã¾ã™ã€‚ï¼ˆç¨€ã«å‡ºæ¥ã‚‹ã¨ããŒã‚ã‚Šã¾ã—ãŸã€‚ï¼‰

ã¨ã„ã†ã‚ã‘ã§ã€å¯¾å‡¦æ³•ã‚’ä½•å€‹ã‹è¦‹ã¤ã‘ã¾ã—ãŸã€‚
ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ§˜ã€…ã ã¨æ€ã†ã®ã§ã€ãã®æ™‚ã€…ã§æœ€é©è§£ã‚’è¦‹ã¤ã‘ãŸã„ã§ã™ã­ã€‚

## ã¼ãã®ã‹ã‚“ãŒãˆãŸã•ã„ãã‚‡ã†ã®ãŸã„ã—ã‚‡ã»ã†
ã“ã‚Œä»¥å¤–ã®è§£æ±ºæ³•ã‚‚ã‚ã‚‹ã‹ã‚‚ã§ã™ãŒã€ã‚µã£ã¨è©¦ã›ãŸã®ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚
### 1. tty:true
ã‚³ãƒ³ãƒ†ãƒŠã®æ°¸ç¶šåŒ–ã§ã™ã­ã€‚ã¾ãã€æ‰‹ã£å–ã‚Šæ—©ã„ã®ã‹ãªã¨ã¯æ€ã†ã‘ã©ã‚„ã‚„åŠ›æŠ€æ„Ÿã¯å¦ã‚ãªã„ãªãã¨æ€ã„ã¾ã™ã€‚
ã‚ã¨ã€è‡ªåˆ†ã¯ttyã¤ã‹ã£ã¦ã‚‚ã‚¢ãƒ—ãƒªè½ã¡ã¡ã‚ƒã†ã“ã¨ã‚ã£ãŸã‹ã‚‰ã€ä¸€éƒ¨ã‚±ãƒ¼ã‚¹ã§ã¯å¯¾å¿œã§ããªã„ã®ã‹ã‚‚ï¼Ÿ
ttyã«ã¤ã„ã¦ã¯ã¨ã£ã¦ã‚‚ã‚ã‹ã‚Šã‚„ã™ã„è¨˜äº‹æ›¸ã„ã¦ãã‚Œã¦ã„ã‚‹æ–¹ãŒã„ãŸã®ã§ãƒªãƒ³ã‚¯è²¼ã£ã¨ãã¾ã™ã€‚
https://zenn.dev/hohner/articles/43a0da20181d34

ä¸€å¿œã€ã“ã‚“ãªæ„Ÿã˜ã§ã™ã­ã€‚
```yml
version: '3.8'
services:
  web:
    tty: trueã€€## ã“ã“
    build: .
    ports:
      - 8000:8000
    volumes:
      - .:/app
    depends_on:
      - db

  db:
    image: mysql:5.7.22
    restart: always
    environment:
      MYSQL_DATABASE: develop
      MYSQL_USER: root
      MYSQL_PASSWORD: root
      MYSQL_ROOT_PASSWORD: root
    volumes:
      - .db:/var/lib/mysql
    ports:
      - 3306:3306
```

### 2. ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†
èª¿ã¹ã¦ã‚‹ã†ã¡ã«è¦‹ã¤ã‘ã¦ä¾¿åˆ©ãã†ã ãªãƒ¼ã¨æ€ã£ãŸã‚„ã¤ã€‚
è¤‡æ•°ã®waitå…ˆã‚‚æŒ‡å®šã§ãã‚‹ã‚‰ã—ã„ã®ã§ã€è¤‡é›‘ãªæ§‹æˆã ã¨åŠ©ã‹ã‚‹ã‹ã‚‚ã€‚

https://github.com/ufoscout/docker-compose-wait

```Dockerfile
# Dockerfileã«ã¯ä»¥ä¸‹ã‚’è¨˜è¼‰ã€‚è©³ã—ãã¯å…¬å¼è¦‹ã¦ä¸‹ã•ã„ã€‚
ADD https://github.com/ufoscout/docker-compose-wait/releases/download/2.9.0/wait /wait
RUN chmod +x /wait
CMD /wait
```

```yml
version: '3.8'
services:
  web:
    build: .
    ports:  
      - 8000:8000
    volumes:
      - .:/app
    depends_on:
      - db
    environment: # environmentã‚’è¿½åŠ ã€‚
      WAIT_HOSTS: db:3306 # waitå…ˆã‚’æŒ‡å®šã™ã‚‹ã€‚"WAIT_HOSTS: host:port"

  db:
    image: mysql:5.7.22
    restart: always
    environment:
      MYSQL_DATABASE: develop
      MYSQL_USER: root
      MYSQL_PASSWORD: root
      MYSQL_ROOT_PASSWORD: root
    volumes:
      - .db:/var/lib/mysql
    ports:
      - 3306:3306
```



### 3. ã‚·ã‚§ãƒ«ã‚’ä½¿ã†
å…¬å¼ã‚‚åŸºæœ¬ã¯ã‚·ã‚§ãƒ«ã§ã‚„ã£ã¦ã€‚ã¿ãŸã„ãªã“ã¨æ›¸ã„ã¦ã‚‹ã®ã§å€‹äººçš„ã«ã¯ã‚ˆã£ã½ã©ã§ãªã‘ã‚Œã°ã“ã‚Œã§è‰¯ã„ã‹ãªã¨æ€ã£ã¦ã¾ã™ã€‚ï¼ˆä¸‹è¨˜ã¯å…¬å¼ã®Postgresã®ä¾‹ã§ã™ã­ï¼‰

```sh
#!/bin/sh
# wait-for-postgres.sh

set -e
  
host="$1"
shift
  
until PGPASSWORD=$POSTGRES_PASSWORD psql -h "$host" -U "postgres" -c '\q'; do
  >&2 echo "Postgres is unavailable - sleeping"
  sleep 1
done
  
>&2 echo "Postgres is up - executing command"
exec "$@"
```

https://docs.docker.com/compose/startup-order/

netcatã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã‚ã‚Œã°ä»¥ä¸‹ã®ã‚ˆã†ãªæ›¸ãæ–¹ã ã¨æ±ç”¨çš„ã‹ã‚‚ã€‚

```sh
# !/bin/bash
echo "waiting for mysql server"

while ! nc -z db 3306; do
  sleep 1
done

echo "Connection Successfully"

exec "$@"
```


ãŠã—ã¾ã„ã€œ