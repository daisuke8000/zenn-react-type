---
title: "DockerÃ—FastAPIÃ—React(TypeScript) on AWS ECSã€frontendã€‘"
emoji: "ğŸ˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [docker, python, react, typescript, aws]
published: true
---

## å‰å›ã®backendç·¨ã‹ã‚‰ã®ç¶šãã§ã™
[backendç·¨](https://zenn.dev/daisukesasaki/articles/f18dd6554f94e3)
æ­£ç›´ã€ãƒ•ãƒ­ãƒ³ãƒˆå´ã¯ã•ã£ã±ã‚Šã‚»ãƒ³ã‚¹ãŒç„¡ã„ï¼‹å¿˜ã‚Œã¾ãã£ã¦ãŸã‚Šã—ãŸã®ã§ã‚ã¡ã‚ƒãã¡ã‚ƒèª¿ã¹ç›´ã—ãŸã€‚
ã‚ã‚‰ãŸã‚ã¦ä¸¡æ–¹ã§ãã‚‹çš†ã•ã‚“ã™ã”ã„ã‚ãã€ã€ï¼ˆã¡ãªã¿ã«åƒ•ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã‚‚ã‚»ãƒ³ã‚¹ãªã„ã§ã™ï¼‰
frontendå´ã«å…¥ã‚‹å‰ã«å‰å›ã‚„ã£ãŸå†…å®¹ãŒã¡ã‚‡ã£ã¨åŠç«¯ã ã£ãŸã®ã§ã¾ãšã¯ãã“ã‚’ã‚µã‚¯ãƒƒã¨ä¿®æ­£ã—ã¦ã—ã¾ãŠã†ã¨æ€ã„ã¾ã™ã€‚


### crud.py
```py
# project/backend/app/api/crud.py
from app.models.pydantic import SummaryPayloadSchema
from app.models.tortoise import TextSummary
from typing import Union, Listiter


async def post(payload: SummaryPayloadSchema) -> int:
    summary = TextSummary(
        summary=payload.summary,
    )
    await summary.save()
    return summary.id


async def get_all() -> List:
    summarys = await TextSummary.all().values()
    return summarys


async def get(id: int) -> Union[dict, None]:
    task = await TextSummary.filter(id=id).first().values()
    if task:
        return task[0]
    return None


async def put(id: int, payload: SummaryPayloadSchema) -> Union[dict, None]:
    task = await TextSummary.filter(id=id).update(
        summary=payload.summary
    )
    if task:
        update_task = await TextSummary.filter(id=id).first().values()
        return update_task[0]
    return None


async def delete(id: int) -> int:
    task = await TextSummary.filter(id=id).first().delete()
    return task
```


### main.py
```py
# project/backend/app/main.py
import logging
import os

from fastapi import FastAPI, HTTPException, Path
from typing import List

from app.api import crud
from app.db import init_db
from fastapi.middleware.cors import CORSMiddleware
from app.models.tortoise import SummarySchema
from app.models.pydantic import SummaryPayloadSchema, SummaryResponseSchema


log = logging.getLogger("uvicorn")


app = FastAPI()

origins = [
    "*",
    "localhost:3000",
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"]
)

@app.on_event("startup")
async def startup_event():
    log.info("Starting up...")
    init_db(app)


@app.on_event("shutdown")
async def shutdown_event():
    log.info("Shutting down...")


@app.post("/todos", response_model=SummaryResponseSchema, status_code=201)
async def create_summary(payload: SummaryPayloadSchema) -> SummaryResponseSchema:
    summary_id = await crud.post(payload)

    response_object = {
        "id": summary_id,
        "summary": payload.summary
    }
    return response_object


@app.get("/todos", response_model=List[SummarySchema])
async def read_all_todo() -> List[SummarySchema]:
    return await crud.get_all()


@app.put("/todos/{id}/", response_model=SummarySchema)
async def update_todo(payload: SummaryPayloadSchema, id: int = Path(..., gt=0)) -> SummarySchema:
    todo = await crud.put(id, payload)
    if not todo:
        raise HTTPException(status_code=404,detail="Todos not found")
    return todo


@app.delete("/todos/{id}/", response_model=SummaryResponseSchema)
async def delete_todo(id: int = Path(..., gt=0)) -> SummaryResponseSchema:
    todo = await crud.get(id)
    if not todo:
        raise HTTPException(status_code=404, detail="Todos not found")
    await crud.delete(id)
    return todo

```

æ›´æ–°ã¨å‰Šé™¤ç”¨ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ã—ãŸã®ã§ã“ã‚Œã§ä¸€æ—¦CRUDã®æ©Ÿèƒ½ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚
http://localhost:8004/docs


ç¢ºèªå‡ºæ¥ãŸã‚‰ä¸€å›æ­¢ã‚ã¨ãã¾ã™ã€‚
```bash
docker-compose stop
```


## ãã‚“ã˜ã‚ƒã‚ã€frontendå´ã„ã£ã¦ã¿ã‚ˆãƒ¼
frontendãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¦ã€Dockerfileã‚’ç”¨æ„ã€‚

```bash
mkdir frontend && cd frontend
touch Dockerfile
```

```Dockerfile
# project/frontend/Dockerfile

#pull official base-image
FROM node:16-alpine
WORKDIR /usr/src/

```

docker-composeã‚‚ä¿®æ­£ã—ã¦ã„ãã¾ã™ã€‚

```yml
version: '3.8'

services:
  web:
    build:
      context: ./project/backend
      dockerfile: Dockerfile
    command: uvicorn app.main:app --reload --workers 1 --host 0.0.0.0 --port 8000
    volumes:
      - ./project/backend:/usr/src/
    environment:
      - DATABASE_URL=postgres://postgres:postgres@web-db:5432/develop
    ports:
      - 8004:8000
    depends_on:
      - web-db

  web-db:
    build:
      context: ./project/backend/db
      dockerfile: Dockerfile
    expose:
      - 5432
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres

  front:
    stdin_open: true
    build:
      context: ./project/frontend
      dockerfile: Dockerfile
    volumes:
      - ./project/frontend:/usr/src/
    ports:
      - 3007:3000
    depends_on:
      - web

```

ä¿®æ­£å¾Œã«ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¾ã™ã€‚

```bash
docker-compose build
docker-compose run front sh -c "npx create-react-app app --template typescript"
```

ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¿”ã£ã¦ããŸã‚‰æ›´ã«ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã—ã‚‡ã†ã€‚

```bash
docker-compose up -d
```

ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªå¾Œã€frontã®ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã‚Šã¾ã™ã€‚

```bash
docker ps
docker-compose exec front sh
```

ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã£ãŸã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¦ã€ChakraUIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
[ChakraUI](https://chakra-ui.com/docs/getting-started)

```sh
cd app
npm i @chakra-ui/react @emotion/react@^11 @emotion/styled@^11 framer-motion@^4
```

çµ‚ã‚ã£ãŸã‚‰ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰å‡ºã¦ã€Dockerfileã¨docker-compose.ymlã‚’å†åº¦ç·¨é›†ã—ã¾ã™ã€‚


```Dockerfile
#pull official base-image
FROM node:16-alpine
WORKDIR /usr/src/app/

#add usr/src/app/node_modules/.bin to $PATH
ENV PATH /usr/src/app/node_modules.bin:$PATH

##install and cache app dependencies
COPY app/package.json .
COPY app/package-lock.json .
#npm install
RUN npm ci
RUN npm install react-scripts@4.0.3 -g --silent
#
#start app
CMD ["npm", "start"]

```


```yml
version: '3.8'

services:
  web:
    build:
      context: ./project/backend
      dockerfile: Dockerfile
    command: uvicorn app.main:app --reload --workers 1 --host 0.0.0.0 --port 8000
    volumes:
      - ./project/backend:/usr/src/
    environment:
      - DATABASE_URL=postgres://postgres:postgres@web-db:5432/develop
    ports:
      - 8004:8000
    depends_on:
      - web-db

  web-db:
    build:
      context: ./project/backend/db
      dockerfile: Dockerfile
    expose:
      - 5432
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres

  front:
    stdin_open: true
    build:
      context: ./project/frontend
      dockerfile: Dockerfile
    volumes:
      - ./project/frontend:/usr/src/
      - /usr/src/app/node_modules
    ports:
      - 3007:3000
    depends_on:
      - web

```

ç·¨é›†å¾Œã¯å†åº¦ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¡ä¸Šã’ã¦ã€ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯å…ˆã«é£›ã‚“ã ã‚‰reactã®ã„ã¤ã‚‚ã®ç”»é¢ãŒç¢ºèªã§ãã¾ã™ã€‚

```bash
docker-compose up -d --build
```

http://localhost:3007


## ã£ã—ã‚ƒã‚ã€ç”»é¢ã¤ãã£ã¦ããã‰
ã¾ãšã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®šã—ã¦ã—ã¾ã„ã¾ã™ã€‚

```bash
mkdir project/frontend/app/src/theme
touch project/frontend/app/src/theme/theme.ts
```

```ts
#project/frontend/app/src/theme/theme.ts
import { extendTheme } from "@chakra-ui/react";

const theme = extendTheme({
    styles:{
        global: {
            body: {
                backgroundColor: "gray.700",
                color: "teal.400",
            }
        }
    }
});

export default theme;
```

ãŠæ¬¡ã¯å‹å®šç¾©ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚

```bash
mkdir project/frontend/app/src/types && mkdir project/frontend/app/src/types/api
touch project/frontend/app/src/types/api/TodoType.ts
```

```ts
export type TodoType = {
    "id": number;
    "summary": string;
    "created_at": string;
}
```


ç¶šã‘ã¦Componentã¨ã„ã†åã°ã‹ã‚Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚
è¨€ã„è¨³ã«ãªã‚Šã¾ã™ãŒã€ã¯ã‚„ãæœ¬é¡Œã®ECSã®è¨˜äº‹ã‚’æ›¸ããŸã„ã®ã§ï¼‘ã¤ã«ã¾ã¨ã‚ã¦ã—ã¾ã„ã¾ã—ãŸã€‚
ã¯ã„ã€‚è¨€ã„è¨³ã§ã™ã€‚

```bash
mkdir project/frontend/app/src/Components
touch project/frontend/app/src/Components/IndexPage.tsx
```

```tsx
import React, {ChangeEvent, memo, useCallback, useEffect, useState, ReactNode, VFC} from "react";
import {
    Box,
    Button,
    Divider,
    Flex,
    Heading,
    Input,
    Stack,
    Text,
    Modal,
    ModalOverlay,
    ModalContent,
    useDisclosure, ModalHeader, ModalCloseButton, ModalBody, FormControl, FormLabel, ModalFooter, FormHelperText,
} from "@chakra-ui/react";
import { TodoType } from "../types/api/TodoType";


export const IndexPage: VFC = memo(() => {
    const [todoName, setTodoName] = useState('');
    const [todos, setTodos] = useState<Array<TodoType>>([]);
    const onChangeTask = (e: ChangeEvent<HTMLInputElement>) => setTodoName(e.target.value);

    const getTodos = useCallback(async() => {
        const response: Response = await fetch("http://localhost:8004/todos")
        await response.json()
            .then((r) => {
                setTodos(r)
            })
            .catch(() => {
                alert("undefined get Reasponse...")
            });
    },[]);

    const onClickAddTodo = () => {
        if (todoName === "") return;
        const newTodo = {
            "id": todos.length + 1,
            "summary": todoName
        }
        fetch("http://localhost:8004/todos", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newTodo)
        }).then(() => {
            getTodos();
        }).catch(() => {
            alert("unknown posted error")
        })
        setTodoName("");
    };

    useEffect( () => {
        getTodos();
    },[getTodos]);


    return (
        <Flex
            align="center"
            color="gray.500"
            height="100vh"
            justify="center"
        >
            <Box
                w="400">
                <Stack spacing={6}>
                    <Heading
                        as="h1"
                        size="lg"
                        textAlign="center"
                    >TodoApp
                    </Heading>
                    <Box w={400}>
                        <Stack>
                            <Input
                                placeholder="Input taskname.."
                                value={todoName}
                                onChange={onChangeTask}
                            />
                            <Button
                                colorScheme="teal"
                                onClick={onClickAddTodo}
                            >Add</Button>
                            <Divider my={"5"}/>
                        </Stack>
                    </Box>
                    {todos.map((todo) => (
                        <Todo
                            key={todo.summary}
                            id={todo.id}
                            item={todo.summary}
                            getTodos={getTodos}
                        />
                    ))}
                </Stack>
            </Box>
        </Flex>
    )
});


type Props = {
    key: string;
    id: number;
    item: string;
    getTodos: () => void;
}

const Todo: VFC<Omit<Props, "key">> = memo((props) => {
    const { id, item, getTodos } = props;

    return (
        <>
            <Box>
                <Text>{item}</Text>
                <UpdateTodo
                    id={id}
                    item={item}
                    getTodos={getTodos}
                >Update</UpdateTodo>
                <DeletedTodo
                    id={id}
                    item={item}
                    getTodos={getTodos}
                >Delete</DeletedTodo>
            </Box>
        </>
    );
});

type UpdateProps = {
    id: number;
    item: string;
    getTodos: () => void;
    children: ReactNode;
}

const UpdateTodo: VFC<UpdateProps> = (props) => {
    const { id, item, getTodos, children } = props;
    const [ todo, setTodo ] = useState(item);
    const { isOpen, onOpen, onClose } = useDisclosure();
    const onClickModalOpen = useCallback(() => onOpen(), [])

    const onChangeTodo = (e: ChangeEvent<HTMLInputElement>) => setTodo(e.target.value);
    const onClickUpdateTodo  = async(id: number, item: string) => {
        await fetch(`http://localhost:8004/todos/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ summary: item })
        })
        onClose();
        getTodos();
    };

    return (
        <>
            <Modal
                isOpen={isOpen}
                onClose={onClose}
                autoFocus={false}
            >
                <ModalOverlay>
                    <ModalContent>
                        <ModalHeader>Task Update</ModalHeader>
                        <ModalCloseButton/>
                        <ModalBody>
                            <Stack>
                                <FormControl>
                                    <FormLabel>Task rename</FormLabel>
                                    <Input
                                        value={todo}
                                        onChange={onChangeTodo}
                                    ></Input>
                                </FormControl>
                            </Stack>
                        </ModalBody>
                        <ModalFooter>
                            <Button onClick={() => onClickUpdateTodo(id, todo)}>Done</Button>
                        </ModalFooter>
                    </ModalContent>
                </ModalOverlay>
            </Modal>
            <Button mr="2" onClick={onClickModalOpen}>{children}</Button>
        </>
    );
};

type DeletedProps = {
    id: number;
    item: string;
    getTodos: () => void;
    children: ReactNode;
}

const DeletedTodo: VFC<DeletedProps> = (props) => {
    const { id, item, getTodos, children } = props;
    const { isOpen, onOpen, onClose } = useDisclosure();
    const onClickModalOpen = useCallback(() => onOpen(), [])

    const onClickDeletedTodo  = async(id: number) => {
        await fetch(`http://localhost:8004/todos/${id}`, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" }
        })
        onClose();
        getTodos();
    };

    return (
        <>
            <Modal
                isOpen={isOpen}
                onClose={onClose}
                autoFocus={false}
            >
                <ModalOverlay>
                    <ModalContent>
                        <ModalHeader>Task Delete</ModalHeader>
                        <ModalCloseButton/>
                        <ModalBody>
                            <Stack>
                                <FormControl>
                                    <FormLabel>this task delete?</FormLabel>
                                    <FormHelperText>{item}</FormHelperText>
                                </FormControl>
                            </Stack>
                        </ModalBody>
                        <ModalFooter>
                            <Button onClick={() => onClickDeletedTodo(id)}>Done</Button>
                        </ModalFooter>
                    </ModalContent>
                </ModalOverlay>
            </Modal>
            <Button onClick={onClickModalOpen}>{children}</Button>
        </>
    );
};


```

æœ€å¾Œã«App.tsxã‚’ç·¨é›†ã—ã¾ã™ã€‚

```tsx
import React from 'react';
import { IndexPage } from "./Components/IndexPage";
import {
  ChakraProvider,
} from "@chakra-ui/react";
import theme from "./theme/theme";


function App() {
  return (
      <>
        <header className="App-header">
          <ChakraProvider theme={theme}>
            <IndexPage/>
          </ChakraProvider>
        </header>
      </>
  );
}

export default App;

```

å†åº¦ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯å…ˆã«é£›ã‚“ã§ã¿ã¾ã™ã€‚
http://localhost:3007

â€»ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã¨ã‹å‡ºã¦æ¶ˆãˆãªã„ã‚ˆã†ã§ã‚ã‚Œã°ä»¥ä¸‹ã‚’å…¥åŠ›ã—ã¦ä¸‹ã•ã„ã€‚
```bash
docker-compose up -d --build
```

## ä»Šã¯ã“ã‚“ãªæ„Ÿã˜ã«ãªã£ã¦ã‚‹ã¯ãš

![](/images/todo-test.gif)


## ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé…ä¸‹
```bash
.
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ project
    â”œâ”€â”€ backend
    â”‚Â Â  â”œâ”€â”€ Dockerfile
    â”‚Â Â  â”œâ”€â”€ app
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ __init__.py
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ api
    â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ crud.py
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ db.py
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ main.py
    â”‚Â Â  â”‚Â Â  â””â”€â”€ models
    â”‚Â Â  â”‚Â Â      â”œâ”€â”€ __init__.py
    â”‚Â Â  â”‚Â Â      â”œâ”€â”€ pydantic.py
    â”‚Â Â  â”‚Â Â      â””â”€â”€ tortoise.py
    â”‚Â Â  â”œâ”€â”€ db
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Dockerfile
    â”‚Â Â  â”‚Â Â  â””â”€â”€ create.sql
    â”‚Â Â  â”œâ”€â”€ entrypoint.sh
    â”‚Â Â  â””â”€â”€ requirements.txt
    â””â”€â”€ frontend
        â”œâ”€â”€ Dockerfile
        â””â”€â”€ app
            â”œâ”€â”€ README.md
            â”œâ”€â”€ node_modules
            â”œâ”€â”€ package-lock.json
            â”œâ”€â”€ package.json
            â”œâ”€â”€ public
            â”‚Â Â  â”œâ”€â”€ favicon.ico
            â”‚Â Â  â”œâ”€â”€ index.html
            â”‚Â Â  â”œâ”€â”€ logo192.png
            â”‚Â Â  â”œâ”€â”€ logo512.png
            â”‚Â Â  â”œâ”€â”€ manifest.json
            â”‚Â Â  â””â”€â”€ robots.txt
            â”œâ”€â”€ src
            â”‚Â Â  â”œâ”€â”€ App.css
            â”‚Â Â  â”œâ”€â”€ App.test.tsx
            â”‚Â Â  â”œâ”€â”€ App.tsx
            â”‚Â Â  â”œâ”€â”€ Components
            â”‚Â Â  â”‚Â Â  â””â”€â”€ IndexPage.tsx
            â”‚Â Â  â”œâ”€â”€ index.css
            â”‚Â Â  â”œâ”€â”€ index.tsx
            â”‚Â Â  â”œâ”€â”€ logo.svg
            â”‚Â Â  â”œâ”€â”€ react-app-env.d.ts
            â”‚Â Â  â”œâ”€â”€ reportWebVitals.ts
            â”‚Â Â  â”œâ”€â”€ setupTests.ts
            â”‚Â Â  â”œâ”€â”€ theme
            â”‚Â Â  â”‚Â Â  â””â”€â”€ theme.ts
            â”‚Â Â  â””â”€â”€ types
            â”‚Â Â      â””â”€â”€ api
            â”‚Â Â          â””â”€â”€ TodoType.ts
            â”œâ”€â”€ tsconfig.json
            â””â”€â”€ yarn.lock

```

## ä»Šå›ã‚‚ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼
ã‚ˆã†ã‚„ãæ¬¡å›AWSã ãœã€ã€
