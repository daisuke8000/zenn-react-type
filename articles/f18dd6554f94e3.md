---
title: "DockerÃ—FastAPIÃ—React(TypeScript) on AWS ECSã€backendã€‘"
emoji: "ğŸ™†"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [docker, python, react, typescript, aws]
published: true
---

## ã¯ã„ã€ã‚„ã£ã¦ã¿ãŸç³»ã§ã™ã€‚
æœ€è¿‘ãšãƒ¼ã£ã¨Inputã°ã£ã‹ã‚Šã ã£ãŸã®ã§ã‚„ã£ãŸã“ã¨æ›¸ãã‹ã€‚ã€‚ã¨ãªã£ãŸæ¬¡ç¬¬ã§ã™ã€‚
ECSã¨ã‹ä½¿ã£ãŸã“ã¨ãªã‹ã£ãŸã®ã§ã€‚ï¼ˆé«˜ã„ã—ã€‚ã€‚ï¼‰
â€»ãŠé‡‘ã¯çŸ¥ã‚‰ã‚“ã†ã¡ã«å…¨ç„¶å¯æ„›ããªã„é‡‘é¡ã«ãªã£ã¦ã‚‹ã®ã§ã”åˆ©ç”¨ã¯è¨ˆç”»çš„ã«ï¼ˆRDSã¨ã‹ã‚‚ä½¿ã£ã¦ãŸã‘ã©ï¼‘é€±ã§3000å††å¼±ãã‚‰ã„ã«ãªã£ã¦ãŸã€‚ã€‚ï¼‰


## æ§‹ç¯‰ã‚¤ãƒ¡ãƒ¼ã‚¸
![](/images/aws-ark.png)


## å‹•ä½œç’°å¢ƒ
- BigSur ver11.4
- MacBook Pro (13-inch, 2019, Two Thunderbolt 3 ports)
- 1.4 GHz ã‚¯ã‚¢ãƒƒãƒ‰ã‚³ã‚¢Intel Core i5
- 16 GB 2133 MHz LPDDR3
- Docker version 20.10.7
- docker-compose version 1.29.2

## è¨€èªãƒ»FW
- Backend:FastAPI(Python)ã€€â†ã€€ä»Šå›ã¯ã“ã‚Œ
- Frontend:React(TypeScript)

## document
- [FastAPIå…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«](https://fastapi.tiangolo.com/)
- [TortoiseORM](https://tortoise-orm.readthedocs.io/en/latest/index.html)


## æœ¬ç« ã§ã®æœ€çµ‚æ§‹æˆ
éšå±¤çµ¡ã¿ã§ãŠã‹ã—ã„ãªã¨ãªã£ãŸã‚‰ã“ã¡ã‚‰å‚è€ƒã«ã—ã¦ã¿ã¦ä¸‹ã•ã„ã€‚
æœ¬ç« ã§ã®backendå´ã®æ§‹æˆã¯æœ€çµ‚çš„ã«ã“ã†ãªã‚Šã¾ã™ã€‚
```bash
.
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ project
    â””â”€â”€ backend
        â”œâ”€â”€ Dockerfile
        â”œâ”€â”€ app
        â”‚Â Â  â”œâ”€â”€ __init__.py
        â”‚Â Â  â”œâ”€â”€ api
        â”‚Â Â  â”‚Â Â  â””â”€â”€ crud.py
        â”‚Â Â  â”œâ”€â”€ db.py
        â”‚Â Â  â”œâ”€â”€ main.py
        â”‚Â Â  â””â”€â”€ models
        â”‚Â Â      â”œâ”€â”€ __init__.py
        â”‚Â Â      â”œâ”€â”€ pydantic.py
        â”‚Â Â      â””â”€â”€ tortoise.py
        â”œâ”€â”€ db
        â”‚Â Â  â”œâ”€â”€ Dockerfile
        â”‚Â Â  â””â”€â”€ create.sql
        â”œâ”€â”€ entrypoint.sh
        â””â”€â”€ requirements.txt
```




## FastAPIã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
1.ã¾ãšã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ˜ã£ã¦ã„ã

```bash
mkdir project && cd project
mkdir backend && cd backend
```


2.backendã®éšå±¤ã«Dockerfile.ymlã‚’ä½œæˆ


```Dockerfile
# project/backend/Dockerfile

FROM python:3.9.6-slim-buster

#working directroy
WORKDIR /usr/src/

#environment variables
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

#install system depedencies
RUN apt-get update \
  && apt-get -y install netcat gcc postgresql \
  && apt-get clean

#install python depedencies
RUN pip install --upgrade pip
COPY ./requirements.txt .
RUN pip install -r requirements.txt

#add app
COPY . .

```

3.pythonã¯requirements.txtã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸é¡ã‚’ç®¡ç†ã§ãã‚‹ã®ã§ä½¿ã†äºˆå®šã®ã‚‚ã®ã‚’é©å½“ã«ç”¨æ„ã—ã¦ãŠãã€‚ã“ã‚Œã‚‚Dockerfileã¨åŒéšå±¤ã«ä½œæˆ

```py
# project/backend/requirements.txt
asyncpg==0.23.0
fastapi==0.65.3
gunicorn==20.1.0
requests==2.25.1
tortoise-orm==0.17.4
uvicorn==0.14.0
```

4.ç¶šã‘ã¦åŒéšå±¤ã«appãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã€‚ã•ã‚‰ã«__init__.pyã¨main.pyã‚’ä½œæˆå¾Œã«ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã—ã¦ãŠãã€‚ï¼ˆ__init__.pyã¯ä½œæˆã—ã¦ãŠãã ã‘ã§ä½•ã‚‚è¨˜è¼‰ã—ãªã„ã§OKï¼‰

```py
# project/backend/app/main.py
from fastapi import FastAPI

app = FastAPI()


@app.get("/ping")
def pong():
    return {"Hello": "world!"}
```


5.docker-compose.ymlã¯projectã®éšå±¤ã«ä½œæˆ
```yml
# docker-compose.yml
version: '3.8'

services:
  web:
    build:
      context: ./project/backend
      dockerfile: Dockerfile
    command: uvicorn app.main:app --reload --workers 1 --host 0.0.0.0 --port 8000
    volumes:
      - ./project/backend:/usr/src/
    ports:
      - 8004:8000
```


6.docker-compose.ymlã®éšå±¤ã¾ã§ç§»å‹•ã—ã¦ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹
```bash
cd ..
docker-compose up -d --build
```

7.ã‚³ãƒ³ãƒ†ãƒŠãŒç«‹ã¡ä¸ŠãŒã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸã‚‰ã€http://localhost:8004/ping ã‚’é–‹ã„ã¦ã€
`{"Hello:"world!"}`ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚‚ç¢ºèªã™ã‚‹

```bash
docker ps
# CONTAINER ID   IMAGE              COMMAND                  CREATED         STATUS         PORTS                                       NAMES
# a280a1a11240   article-todo_web   "uvicorn app.main:apâ€¦"   2 minutes ago   Up 2 minutes   0.0.0.0:8004->8000/tcp, :::8004->8000/tcp   todo_web_1
```

ç¢ºèªã§ããŸã‚‰ä¸€æ—¦downã•ã›ã‚‹
```bash
docker-compose down
```


#### ã“ã“ã¾ã§ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé…ä¸‹

```bash
.
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ project
    â””â”€â”€ backend
        â”œâ”€â”€ Dockerfile
        â”œâ”€â”€ app
        â”‚Â Â  â”œâ”€â”€ __init__.py
        â”‚Â Â  â””â”€â”€ main.py
        â””â”€â”€ requirements.txt
```


æ¬¡ã¯DBã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã„ã

## Postgresã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

8.backendä»¥ä¸‹ã®éšå±¤ã«dbãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€ã•ã‚‰ã«create.sqlã‚’ä½œæˆã™ã‚‹
```bash
mkdir project/backend/db
```

ã¡ãªã¿ã«sqlã®ä¸­èº«ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä»»æ„ã®åå‰ã§ä½œæˆã™ã‚‹ã ã‘
```sql
# project/backend/db/create.sql
CREATE DATABASE develop;
```

9.Postgresã®BaseImageã§Dockerfileã‚’ä½œæˆã€‚è£œè¶³ã¨ã—ã¦ã¯ã‚³ãƒ³ãƒ†ãƒŠå†…ã®`docker-entrypoint-initdb.d`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«`create.sql`ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€å…¬å¼ã®Postgresã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆAlpineãƒ™ãƒ¼ã‚¹ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰ã‚’æ‹¡å¼µã™ã‚‹ã“ã¨ãŒã§ãã‚‹ãã†ãªã€‚

```Dockerfile
# project/backend/db/Dockerfile
FROM postgres:13-alpine

# run create.sql on init
ADD create.sql /docker-entrypoint-initdb.d
```

10.å…ˆç¨‹ä½œæˆã—ãŸdocker-compose.ymlã‚’ç·¨é›†ã™ã‚‹
```yml
version: '3.8'

services:
  web:
    build:
      context: ./project/backend
      dockerfile: Dockerfile
    command: uvicorn app.main:app --reload --workers 1 --host 0.0.0.0 --port 8000
    volumes:
      - ./project/backend:/usr/src/
    environment:
      - DATABASE_URL=postgres://postgres:postgres@web-db:5432/develop
    ports:
      - 8004:8000
    depends_on:
      - web-db


  web-db:
    build:
      context: ./project/backend/db
      dockerfile: Dockerfile
    expose:
      - 5432
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
```

11.Poastgresã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ã‚’å‚ç…§ã™ã‚‹ãŸã‚ã«entrypoint.shã‚’ä½œæˆã™ã‚‹

```sh
#!/bin/bash

echo "waiting for postgres server"

while ! nc -z web-db 5432; do
  sleep 0.5
done

echo "Connection Successfully"

exec "$@"
```

12.2ã§ä½œæˆã—ãŸã€backendã®Dockerfileã‚’ç·¨é›†ã™ã‚‹

```Dockerfile
#official base-image python
FROM python:3.9.6-slim-buster

#working directroy
WORKDIR /usr/src/

#environment variables
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

#install system depedencies
RUN apt-get update \
  && apt-get -y install netcat gcc postgresql \
  && apt-get clean

#install python depedencies
RUN pip install --upgrade pip
COPY ./requirements.txt .
RUN pip install -r requirements.txt

#add app
COPY . .

#add entrypoint.sh
COPY ./entrypoint.sh .
RUN chmod +x /usr/src/entrypoint.sh

#entrypoint.sh
ENTRYPOINT ["/usr/src/entrypoint.sh"]
```

13.ç·¨é›†ã—ãŸã‚‰ã€å†ã³ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã•ã›ã‚‹
ãã®å‰ã«entrypoint.shã®å®Ÿè¡Œæ¨©é™ã‚’ä¸ãˆã¨ãã®ã‚’å¿˜ã‚Œãšã«ã€‚ã€‚
```bash
chmod +x project/backend/entrypoint.sh
docker-compose up -d --build
```

14.entrypoint.shã®æŒ™å‹•ã‚’ç¢ºèªã—ã¦ãŠã
```bash
docker-compose logs web

# Attaching to article-todo_web_1
# web_1     | waiting for postgres server
# web_1     | Connection Successfully
# web_1     | INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
# web_1     | INFO:     Started reloader process [1] using statreload
# web_1     | INFO:     Started server process [14]
# web_1     | INFO:     Waiting for application startup.
# web_1     | INFO:     Application startup complete.
```

#### ã“ã“ã¾ã§ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé…ä¸‹
```bash
.
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ project
    â””â”€â”€ backend
        â”œâ”€â”€ Dockerfile
        â”œâ”€â”€ app
        â”‚Â Â  â”œâ”€â”€ __init__.py
        â”‚Â Â  â””â”€â”€ main.py
        â”œâ”€â”€ db
        â”‚Â Â  â”œâ”€â”€ Dockerfile
        â”‚Â Â  â””â”€â”€ create.sql
        â”œâ”€â”€ entrypoint.sh
        â””â”€â”€ requirements.txt
```

ç¢ºèªã§ããŸã®ã§ã¾ãŸdownã•ã›ã¨ã
```bash
docker-compose down
```


## TortoiseORMã®å®Ÿè£…
Pythonè£½ORMã®ä»£è¡¨é¸æ‰‹ã¨ã„ãˆã°SQLAlchemyã§ã—ã‚‡ã†ã€‚å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚‚SQLAlchemyä½¿ã£ã¦ã¾ã™ã‚ˆã­ã€‚
è‡ªåˆ†ã¯æ¥­å‹™ã§Djangoä½¿ã£ã¦ã‚‹ã®ã§ä¼¼ãŸã‚ˆã†ãªé›°å›²æ°—ã®éåŒæœŸORMã¨ã‹ã„ã„ã‚“ã˜ã‚ƒã­ï¼Ÿã¨è¨€ã†ç†ç”±ã§TortoiseORMã‚’æ¡ç”¨ã€‚


15.appã®é…ä¸‹ã«ORMç”¨ã®db.pyã‚’ä½œæˆã™ã‚‹ã€‚
```py
# project/backend/app/db.py
import os

from fastapi import FastAPI
from tortoise import Tortoise, run_async
from tortoise.contrib.fastapi import register_tortoise


TORTOISE_ORM = {
    "connections": {"default": os.environ.get("DATABASE_URL")},
    "apps": {
        "models": {
            "models": ["app.models.tortoise"],
            "default_connection": "default",
        },
    },
}


def init_db(app: FastAPI) -> None:
    register_tortoise(
        app,
        db_url=os.environ.get("DATABASE_URL"),
        modules={"models": ["app.models.tortoise"]},
        generate_schemas=False,
        add_exception_handlers=True,
    )


async def generate_schema() -> None:

    await Tortoise.init(
        db_url=os.environ.get("DATABASE_URL"),
        modules={"models": ["models.tortoise"]},
    )
    await Tortoise.generate_schemas()
    await Tortoise.close_connections()


if __name__ == "__main__":
    run_async(generate_schema())
```



16.appã¨åŒã˜éšå±¤ã«modelsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆå¾Œã€ãã®é…ä¸‹ã«`model`ã¨ã™ã‚‹tortoise.pyã€Responseã¨Outputã®å‹å®šç¾©ã¨ã—ã¦pydantic.pyã‚’ä½œæˆã™ã‚‹.
(__init__/pyã‚‚main.pyä½œæˆã—ãŸã¨ãåŒæ§˜ã«ç©ºã£ã½ã§é…ç½®ã™ã‚‹)


```bash
mkdir project/backend/app/modelss
```


```py
# project/backend/app/models/tortoise.py
from tortoise import fields, models
from tortoise.contrib.pydantic import pydantic_model_creator


class TextSummary(models.Model):
	summary = fields.TextField()
	created_at = fields.DatetimeField(auto_now_add=True)

	def __str__(self):
		return self.summary


SummarySchema = pydantic_model_creator(TextSummary)
```

```py
# project/backend/app/models/pydantic.py
from pydantic import BaseModel


class SummaryPayloadSchema(BaseModel):
    summary: str


class SummaryResponseSchema(SummaryPayloadSchema):
    id: int
```

17.appã¨åŒã˜éšå±¤ã«apiãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆå¾Œã€apiãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã«ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç”¨ã®crud.pyã‚’ä½œæˆã™ã‚‹ã€‚ï¼ˆå…¨éƒ¨æ›¸ãã®ã ã‚‹ã‹ã£ã£ãŸã®ã§ã¨ã‚Šã‚ãˆãšPOSTã¨GETã ã‘ã€‚ã€‚ã€‚ã‚ã¨ã‹ã‚‰ä¿®æ­£ã—ã¾ã™ã€‚ã€‚ã€‚ï¼‰

```py
# project/backend/app/api/crud.py
from app.models.pydantic import SummaryPayloadSchema
from app.models.tortoise import TextSummary
from typing import List


async def post(payload: SummaryPayloadSchema) -> int:
    summary = TextSummary(
        summary=payload.summary,
    )
    await summary.save()
    return summary.id


async def get_all() -> List:
    summarys = await TextSummary.all().values()
    return summarys
```


18.æœ€å¾Œã«main.pyã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ç·¨é›†ã—ã¦ä¸€æ—¦çµ‚äº†
```py
import logging
import os

from fastapi import FastAPI
from typing import List

from app.api import crud
from app.db import init_db
from app.models.tortoise import SummarySchema
from app.models.pydantic import SummaryPayloadSchema, SummaryResponseSchema


log = logging.getLogger("uvicorn")


app = FastAPI()


@app.on_event("startup")
async def startup_event():
    log.info("Starting up...")
    init_db(app)


@app.on_event("shutdown")
async def shutdown_event():
    log.info("Shutting down...")


@app.post("/", response_model=SummaryResponseSchema, status_code=201)
async def create_summary(payload: SummaryPayloadSchema) -> SummaryResponseSchema:
    summary_id = await crud.post(payload)

    response_object = {
        "id": summary_id,
        "summary": payload.summary
    }
    return response_object


@app.get("/", response_model=List[SummarySchema])
async def read_all_todo() -> List[SummarySchema]:
    return await crud.get_all()
```

19.docker-composeã‚’èµ·å‹•ã•ã›ã¾ã™ã€‚
```bash
docker-compose up -d --build
```

20.æ­£å¸¸ã«èµ·å‹•ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ããŸã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹ãŸã‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™
```bash
docker-compose exec web python app/db.py
```

ã“ã“ã‚‚æ­£å¸¸ã«å®Ÿè¡Œã•ã‚ŒãŸã‚‰ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ã€ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

```bash
docker-compose exec web-db psql -U postgres
# db psql -U postgres
# psql (13.3)
# Type "help" for help.

postgres=\c develop

# You are now connected to database "develop" as user "postgres".
develop=\dt
#            List of relations
# Schema |    Name     | Type  |  Owner
# --------+-------------+-------+----------
# public | textsummary | table | postgres
(1 row)
```

21.æœ€å¾Œã«POSTã¨GETã®æŒ™å‹•ã‚’ç¢ºèªã—ã¾ã™ã€‚http://localhost:8004/docs
Swagger UIãŒã‚ã‚‹ã¨æ¥½ã¡ã‚“ã§ã™ã­ã‚§ã€‚ã€‚

â€»ä¸€å¿œcurlã ã¨ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚‹
- POST
```bash
curl -X 'POST' \
  'http://localhost:8004/' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "summary": "Test"
}'
```

- GET
```bash
curl -X 'GET' \
  'http://localhost:8004/' \
  -H 'accept: application/json'
```

```bash
[
  {
    "id": 1,
    "summary": "Test",
    "created_at": "2021-08-02T00:26:28.040690+00:00"
  }
]
```


## ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼
ãŠæ¬¡ã¯frontendç·¨ã§ã™ï¼
